<!doctype html>
<html>
<head>
  <meta charset="utf-8"><title>EV Charger Booking - Admin</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="topbar">
    <div class="brand">EV Charger Booking - Admin</div>
    <div class="right">
      <div id="welcomeAdmin" style="color:#6b7280; margin-right:12px;"></div>
      <button onclick="logout()" class="btn-redsmall" style="background:#ef4444;color:white;padding:8px 12px;border-radius:8px;">Logout</button>
    </div>
  </div>

  <div class="container">
    <div class="card-large">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 class="h2">System Overview</h2>
          <div class="overview">
            <div class="kpi"><div style="color:#6b7280">Total Stations</div><strong id="k1">0</strong></div>
            <div class="kpi"><div style="color:#6b7280">Total Users</div><strong id="k2">0</strong></div>
            <div class="kpi"><div style="color:#6b7280">Total Revenue</div><strong id="k3">â‚¹0.00</strong></div>
            <div class="kpi"><div style="color:#6b7280">Active Bookings</div><strong id="k4">0</strong></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card-large">
      <h2 class="h2">Station Management</h2>
      <div style="display:flex; gap:12px; margin-bottom:12px;">
        <input id="stationName" placeholder="Station Name" style="flex:1;">
        <input id="stationLocation" placeholder="Location" style="flex:1;">
        <button id="addStationBtn" class="btn-blue">Add Station</button>
      </div>

      <table class="table" id="stationsTable">
        <thead><tr><th>ID</th><th>NAME</th><th>LOCATION</th><th>ACTIONS</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card-large">
      <h2 class="h2">Charger Management</h2>
      <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
        <select id="chargerStationSelect" style="width:240px;"></select>
        <input id="chargerName" placeholder="Charger (Booth)" style="flex:1;">
        <input id="chargerType" placeholder="Type (AC Fast)" style="width:160px;">
        <input id="chargerPrice" placeholder="Price/hr" style="width:120px;">
        <button id="addChargerBtn" class="btn-green">Add Charger</button>
      </div>

      <table class="table" id="chargersTable">
        <thead><tr><th>ID</th><th>STATION</th><th>NAME</th><th>TYPE</th><th>PRICE</th><th>ACTION</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

<script>
async function api(path, opts){ const r=await fetch(path, opts); return r.json(); }

function logout(){ localStorage.removeItem('ev_user'); location.href='/'; }

async function loadOverview(){
  const s = await api('/api/stations'); document.getElementById('k1').textContent = s.length;
  const u = await api('/api/slots'); document.getElementById('k4').textContent = (u.filter(x=>x.is_booked==1)).length;
  // users count quick
  const users = await api('/api/auth?dummy=1').catch(()=>[]); // fallback
  document.getElementById('k2').textContent = 'N/A';
}

async function loadStations(){
  const rows = await api('/api/stations');
  const tb = document.querySelector('#stationsTable tbody'); tb.innerHTML='';
  const sel = document.getElementById('chargerStationSelect'); sel.innerHTML='';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.station_id}</td><td>${r.station_name}</td><td>${r.location}</td>
      <td><button class="btn-redsmall" onclick="deleteStation(${r.station_id})">Delete</button></td>`;
    tb.appendChild(tr);
    const opt = document.createElement('option'); opt.value=r.station_id; opt.textContent=r.station_name + ' - ' + r.location;
    sel.appendChild(opt);
  });
}

async function loadChargers(){
  const rows = await api('/api/chargers');
  const tb = document.querySelector('#chargersTable tbody'); tb.innerHTML='';
  const stations = await api('/api/stations');
  rows.forEach(r=>{
    const st = stations.find(s=>s.station_id===r.station_id);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.booth_id}</td><td>${st?st.station_name:r.station_id}</td><td>${r.booth_name}</td><td>${r.charger_type}</td><td>${r.price_per_hour}</td>
      <td><button class="btn-redsmall" onclick="deleteCharger(${r.booth_id})">Delete</button></td>`;
    tb.appendChild(tr);
  });
}

async function addStation(){
  const name = document.getElementById('stationName').value.trim();
  const location = document.getElementById('stationLocation').value.trim();
  if(!name) return alert('Enter name');
  await api('/api/stations', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ station_name:name, location })});
  document.getElementById('stationName').value=''; document.getElementById('stationLocation').value='';
  await loadStations(); await loadChargers(); alert('Station added');
}

async function addCharger(){
  const station_id = document.getElementById('chargerStationSelect').value;
  const booth_name = document.getElementById('chargerName').value.trim();
  const charger_type = document.getElementById('chargerType').value.trim();
  const price = document.getElementById('chargerPrice').value || 50;
  if(!booth_name) return alert('enter charger name');
  await api('/api/chargers', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ station_id, booth_name, charger_type, price_per_hour: price })});
  document.getElementById('chargerName').value=''; document.getElementById('chargerType').value=''; document.getElementById('chargerPrice').value='';
  await loadChargers(); alert('Charger added');
}

async function deleteStation(id){
  if(!confirm('Delete station?')) return;
  await fetch('/api/stations/'+id, { method:'DELETE' }).catch(()=>null);
  await loadStations(); await loadChargers();
}
async function deleteCharger(id){
  if(!confirm('Delete charger?')) return;
  await fetch('/api/chargers/'+id, { method:'DELETE' }).catch(()=>null);
  await loadChargers();
}

document.addEventListener('DOMContentLoaded', async ()=>{
  const u = JSON.parse(localStorage.getItem('ev_user')||'{}');
  document.getElementById('welcomeAdmin').textContent = u.user ? `Welcome, ${u.user.name}` : '';
  await loadOverview(); await loadStations(); await loadChargers();
});
</script>

</body>
</html>
