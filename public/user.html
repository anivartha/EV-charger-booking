<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Dashboard - EV Charger Booking</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <!-- Navigation Header -->
  <nav class="bg-white shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center">
          <h1 class="text-xl font-bold text-gray-800">EV Charger Booking - User</h1>
        </div>
        <div class="flex items-center space-x-4">
          <span id="welcomeMessage" class="text-gray-700"></span>
          <button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
            Logout
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Booking Form -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Book a Charger Slot</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Select Station</label>
          <select id="station-select" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
            <option value="">Loading stations...</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Select Charger</label>
          <select id="charger-select" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" disabled>
            <option value="">Select station first</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Select Date (Next 3 Days Only)</label>
          <input type="date" id="booking-date" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" 
            min="" max="" />
          <p class="text-xs text-gray-500 mt-1">Bookings allowed only for today and next 2 days</p>
        </div>
      </div>

      <!-- Slot Selector -->
      <div id="slot-selector-container" class="mb-4 hidden">
        <label class="block text-sm font-medium text-gray-700 mb-2">Available Time Slots (30 minutes each)</label>
        <div id="slots-grid" class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2 max-h-64 overflow-y-auto p-4 border rounded-lg bg-gray-50">
          <!-- Slots will be populated here -->
        </div>
        <p class="text-sm text-gray-500 mt-2">
          <span class="inline-block w-4 h-4 bg-green-200 border border-green-400 rounded mr-1"></span> Available
          <span class="inline-block w-4 h-4 bg-red-200 border border-red-400 rounded mr-1 ml-4"></span> Booked
          <span class="inline-block w-4 h-4 bg-blue-200 border border-blue-400 rounded mr-1 ml-4"></span> Selected
        </p>
      </div>

      <div id="booking-message" class="hidden p-3 rounded-lg text-sm mb-4"></div>

      <button id="book-btn" class="w-full py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors" disabled>
        Confirm Booking
      </button>
    </div>

    <!-- My Bookings -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h3 class="text-xl font-semibold text-gray-700 mb-4">My Bookings</h3>
      <div id="user-bookings" class="space-y-3">
        <p class="text-gray-500 italic">Loading bookings...</p>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3000/api';
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    let selectedSlots = [];

    // Check authentication
    if (!user || user.role !== 'user') {
      alert('Access denied. Please login as user.');
      window.location.href = 'login.html';
    }

    // Display welcome message
    document.getElementById('welcomeMessage').textContent = `Welcome, ${user.username} (${user.role})`;

    // Logout handler
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('user');
      window.location.href = 'login.html';
    });

    // Load stations
    async function loadStations() {
      try {
        const res = await fetch(`${API_BASE}/stations_new`);
        const data = res.ok ? await res.json() : { stations: [] };
        const stations = data.stations || [];

        const select = document.getElementById('station-select');
        select.innerHTML = '<option value="">Select Station</option>';
        stations.forEach(s => {
          const option = document.createElement('option');
          option.value = s.station_id;
          option.textContent = `${s.station_name} - ${s.location}`;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading stations:', error);
      }
    }

    // Load chargers for selected station
    document.getElementById('station-select').addEventListener('change', async (e) => {
      const stationId = e.target.value;
      const chargerSelect = document.getElementById('charger-select');
      
      if (!stationId) {
        chargerSelect.innerHTML = '<option value="">Select station first</option>';
        chargerSelect.disabled = true;
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/chargers_new?station_id=${stationId}`);
        const data = res.ok ? await res.json() : { chargers: [] };
        const chargers = data.chargers || [];

        chargerSelect.innerHTML = '<option value="">Select Charger</option>';
        chargers.filter(c => c.status === 'Available').forEach(c => {
          const option = document.createElement('option');
          option.value = c.charger_id;
          option.textContent = `${c.charger_type} (${c.power_kw} kW)`;
          chargerSelect.appendChild(option);
        });

        chargerSelect.disabled = false;
      } catch (error) {
        console.error('Error loading chargers:', error);
      }
    });

    // Load slots when charger and date are selected
    async function loadSlots() {
      const chargerId = document.getElementById('charger-select').value;
      const date = document.getElementById('booking-date').value;
      const container = document.getElementById('slot-selector-container');
      const grid = document.getElementById('slots-grid');

      if (!chargerId || !date) {
        container.classList.add('hidden');
        document.getElementById('book-btn').disabled = true;
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/slots?charger_id=${chargerId}&slot_date=${date}`);
        const data = res.ok ? await res.json() : { all: [] };
        const slots = data.all || [];

        if (slots.length === 0) {
          grid.innerHTML = '<p class="col-span-full text-gray-500">No slots available for this date</p>';
        } else {
          grid.innerHTML = slots.map(slot => {
            const isBooked = slot.is_booked;
            const isSelected = selectedSlots.includes(slot.slot_time);
            const timeStr = slot.slot_time.substring(0, 5); // HH:MM format

            return `
              <button
                type="button"
                data-time="${slot.slot_time}"
                data-slot-id="${slot.slot_id}"
                class="px-3 py-2 text-xs rounded border transition-colors ${
                  isBooked
                    ? 'bg-red-200 border-red-400 text-red-700 cursor-not-allowed'
                    : isSelected
                    ? 'bg-blue-200 border-blue-400 text-blue-700'
                    : 'bg-green-200 border-green-400 text-green-700 hover:bg-green-300'
                }"
                ${isBooked ? 'disabled' : ''}
                onclick="toggleSlot('${slot.slot_time}')"
              >
                ${timeStr}
              </button>
            `;
          }).join('');
        }

        container.classList.remove('hidden');
      } catch (error) {
        console.error('Error loading slots:', error);
        grid.innerHTML = '<p class="col-span-full text-red-500">Error loading slots</p>';
      }
    }

    // Toggle slot selection
    window.toggleSlot = (time) => {
      const index = selectedSlots.indexOf(time);
      if (index > -1) {
        selectedSlots.splice(index, 1);
      } else {
        selectedSlots.push(time);
      }
      selectedSlots.sort();
      loadSlots();
      updateBookButton();
    };

    // Update book button state
    function updateBookButton() {
      const btn = document.getElementById('book-btn');
      btn.disabled = selectedSlots.length === 0;
    }

    // Event listeners
    document.getElementById('charger-select').addEventListener('change', loadSlots);
    document.getElementById('booking-date').addEventListener('change', loadSlots);

    // Create booking
    document.getElementById('book-btn').addEventListener('click', async () => {
      const chargerId = document.getElementById('charger-select').value;
      const date = document.getElementById('booking-date').value;
      const messageDiv = document.getElementById('booking-message');

      if (!chargerId || !date || selectedSlots.length === 0) {
        messageDiv.className = 'p-3 rounded-lg text-sm mb-4 bg-red-50 text-red-700';
        messageDiv.textContent = 'Please select charger, date, and at least one slot';
        messageDiv.classList.remove('hidden');
        return;
      }

      try {
        // Create booking for each selected slot (or combine consecutive slots)
        const sortedSlots = [...selectedSlots].sort();
        const startTime = sortedSlots[0];
        const endTime = sortedSlots[sortedSlots.length - 1];
        
        // Calculate end time (add 30 minutes to last slot)
        const [hours, minutes] = endTime.split(':');
        const endDate = new Date();
        endDate.setHours(parseInt(hours), parseInt(minutes) + 30, 0, 0);
        const endTimeStr = `${endDate.getHours().toString().padStart(2, '0')}:${endDate.getMinutes().toString().padStart(2, '0')}:00`;

        const slotStart = new Date(`${date}T${startTime}`);
        const slotEnd = new Date(`${date}T${endTimeStr}`);

        const res = await fetch(`${API_BASE}/bookings_new`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: user.id,
            charger_id: chargerId,
            slot_start: slotStart.toISOString(),
            slot_end: slotEnd.toISOString()
          })
        });

        const data = await res.json();

        if (res.ok) {
          messageDiv.className = 'p-3 rounded-lg text-sm mb-4 bg-green-50 text-green-700';
          messageDiv.textContent = 'Booking created successfully!';
          messageDiv.classList.remove('hidden');
          
          // Reset form
          selectedSlots = [];
          document.getElementById('booking-date').value = '';
          document.getElementById('charger-select').value = '';
          document.getElementById('station-select').value = '';
          document.getElementById('slot-selector-container').classList.add('hidden');
          document.getElementById('book-btn').disabled = true;
          
          // Reload bookings
          loadBookings();
        } else {
          messageDiv.className = 'p-3 rounded-lg text-sm mb-4 bg-red-50 text-red-700';
          messageDiv.textContent = data.error || 'Booking failed';
          messageDiv.classList.remove('hidden');
        }
      } catch (error) {
        messageDiv.className = 'p-3 rounded-lg text-sm mb-4 bg-red-50 text-red-700';
        messageDiv.textContent = 'Could not connect to server';
        messageDiv.classList.remove('hidden');
        console.error('Booking error:', error);
      }
    });

    // Load user bookings
    async function loadBookings() {
      try {
        const res = await fetch(`${API_BASE}/bookings_new?user_id=${user.id}`);
        const data = res.ok ? await res.json() : { bookings: [] };
        const bookings = data.bookings || [];

        const div = document.getElementById('user-bookings');
        if (bookings.length === 0) {
          div.innerHTML = '<p class="text-gray-500 italic">No bookings found.</p>';
        } else {
          div.innerHTML = bookings.map(booking => {
            const start = new Date(booking.slot_start);
            const end = new Date(booking.slot_end);
            const isPast = end < new Date();

            return `
              <div class="p-4 rounded-lg border ${isPast ? 'bg-gray-50 border-gray-200' : 'bg-yellow-50 border-yellow-200'}">
                <div class="flex justify-between items-start">
                  <div>
                    <p class="font-bold">${booking.station_name || 'Station'} - ${booking.charger_type} (${booking.power_kw} kW)</p>
                    <p class="text-sm text-gray-600">${start.toLocaleString()} - ${end.toLocaleString()}</p>
                    <p class="text-sm text-gray-600">Amount: â‚¹${booking.amount || 0}</p>
                  </div>
                  <span class="px-2 py-1 rounded-full text-xs ${
                    booking.status === 'confirmed' ? 'bg-green-300 text-green-700' :
                    booking.status === 'pending' ? 'bg-yellow-300 text-yellow-700' :
                    booking.status === 'completed' ? 'bg-blue-300 text-blue-700' :
                    'bg-red-300 text-red-700'
                  }">${booking.status}</span>
                </div>
              </div>
            `;
          }).join('');
        }
      } catch (error) {
        console.error('Error loading bookings:', error);
      }
    }

    // Set date input min/max (3-day range)
    function setDateLimits() {
      const dateInput = document.getElementById('booking-date');
      const today = new Date();
      const maxDate = new Date(today);
      maxDate.setDate(maxDate.getDate() + 2); // Today + 2 days = 3 days total
      
      dateInput.min = today.toISOString().split('T')[0];
      dateInput.max = maxDate.toISOString().split('T')[0];
    }

    // Initialize
    setDateLimits();
    loadStations();
    loadBookings();
  </script>
</body>
</html>
